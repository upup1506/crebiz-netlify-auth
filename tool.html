<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CreBiz YouTube Analytics Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans KR", sans-serif;
      background-color: #f5f5f5;
      color: #222;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 700;
      text-align: center;
    }
    .note {
      margin: 0 0 16px;
      font-size: 13px;
      text-align: center;
      color: #666;
      line-height: 1.4;
    }

    .api-key-box {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
      margin-bottom: 6px;
      padding: 10px 12px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .api-key-box label {
      font-size: 13px;
      color: #333;
      white-space: nowrap;
    }
    #apiKeyInput {
      flex: 1 1 220px;
      max-width: 420px;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      outline: none;
      background-color: #fafafa;
    }
    #apiKeyInput:focus {
      border-color: #cc0000;
      box-shadow: 0 0 0 2px rgba(204,0,0,0.12);
      background-color: #fff;
    }
    #saveApiKeyBtn {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #444;
      color: #fff;
      font-weight: 500;
      white-space: nowrap;
      transition: background-color 0.15s, transform 0.05s;
    }
    #saveApiKeyBtn:hover { background-color: #222; }
    #saveApiKeyBtn:active { transform: scale(0.97); }

    #howToBtn {
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #2563eb;
      color: #fff;
      font-weight: 500;
      white-space: nowrap;
    }

    #apiKeyMeta {
      margin: 0 0 10px;
      font-size: 12px;
      text-align: center;
      color: #6b7280;
    }

    #search-form {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    #queryInput {
      flex: 1 1 260px;
      max-width: 480px;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      outline: none;
      background-color: #fff;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    #queryInput:focus {
      border-color: #cc0000;
      box-shadow: 0 0 0 2px rgba(204,0,0,0.15);
    }
    #searchBtn {
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #cc0000;
      color: #fff;
      font-weight: 600;
      transition: background-color 0.2s, transform 0.05s;
      white-space: nowrap;
    }
    #searchBtn:hover { background-color: #e60000; }
    #searchBtn:active { transform: scale(0.98); }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      font-size: 13px;
    }
    .filter-group {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background-color: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .filter-group label {
      font-weight: 600;
      color: #444;
      white-space: nowrap;
    }
    .filter-group select {
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background-color: #fafafa;
      outline: none;
    }
    .filter-group select:focus {
      border-color: #cc0000;
      box-shadow: 0 0 0 2px rgba(204,0,0,0.15);
      background-color: #fff;
    }

    .ratio-options,
    .exposure-options {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 4px 8px;
      align-items: center;
    }
    .ratio-options label,
    .exposure-options label {
      font-weight: 400;
      color: #333;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }
    .ratio-options input[type="checkbox"],
    .exposure-options input[type="checkbox"] {
      cursor: pointer;
    }
    .ratio-reset-btn {
      margin-left: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background-color: #fafafa;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
    }
    .ratio-reset-btn:hover { background-color: #eee; }

    .view-export-group {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background-color: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .view-toggle {
      display: inline-flex;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #ddd;
    }
    .view-btn {
      padding: 4px 10px;
      font-size: 12px;
      border: none;
      background-color: transparent;
      cursor: pointer;
      white-space: nowrap;
    }
    .view-btn.active {
      background-color: #cc0000;
      color: #fff;
    }
    #exportBtn {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background-color: #fafafa;
      cursor: pointer;
      white-space: nowrap;
    }
    #exportBtn:hover { background-color: #eee; }

    #status {
      margin: 6px 0;
      text-align: center;
      font-size: 14px;
      color: #444;
      min-height: 20px;
    }
    #error {
      margin: 4px 0 8px;
      text-align: center;
      color: #b00020;
      font-size: 13px;
      min-height: 18px;
    }

    .results { margin-top: 16px; }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .card {
      display: flex;
      flex-direction: column;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      overflow: hidden;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .thumbnail-wrapper {
      width: 100%;
      position: relative;
      padding-top: 56.25%;
      overflow: hidden;
      background-color: #000;
    }
    .thumbnail-wrapper img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .card-body {
      padding: 12px 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }
    .title {
      font-size: 15px;
      font-weight: 600;
      margin: 0;
      line-height: 1.3;
    }
    .title a {
      color: #111;
      text-decoration: none;
    }
    .title a:hover { text-decoration: underline; }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
      color: #555;
    }
    .meta-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .label {
      font-weight: 600;
      color: #333;
    }
    .tags {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .tag {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background-color: #f1f3f4;
      color: #555;
      max-width: 160px;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    .table-wrapper {
      overflow-x: auto;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead { background-color: #f5f5f5; }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
    }
    th { font-weight: 600; }
    td.thumbnail-cell img {
      width: 96px;
      height: auto;
      display: block;
    }
    td.title-cell {
      white-space: normal;
      max-width: 260px;
    }
    td.subs-cell {
      white-space: normal;
      max-width: 140px;
    }
    td.tags-cell {
      white-space: normal;
      max-width: 200px;
    }
    td a {
      color: #111;
      text-decoration: none;
    }
    td a:hover { text-decoration: underline; }

    .sort-icons {
      display: inline-flex;
      flex-direction: column;
      margin-left: 2px;
      vertical-align: middle;
    }
    .sort-icon {
      border: none;
      background: transparent;
      padding: 0;
      margin: -2px 0;
      font-size: 10px;
      line-height: 1;
      cursor: pointer;
      color: #999;
    }
    .sort-icon.active {
      color: #000;
      font-weight: 700;
    }

    .no-results {
      text-align: center;
      margin-top: 40px;
      font-size: 15px;
      color: #555;
    }
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid #ccc;
      border-top-color: #cc0000;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .ratio-label.level1 { color: #777; }
    .ratio-label.level2 { color: #6b7280; }
    .ratio-label.level3 { color: #2563eb; }
    .ratio-label.level4 { color: #dc2626; }
    .ratio-label.level5 { color: #b91c1c; font-weight:600; }

    .exposure-label.level1 { color:#9ca3af; }
    .exposure-label.level2 { color:#6b7280; }
    .exposure-label.level3 { color:#16a34a; }
    .exposure-label.level4 { color:#2563eb; }
    .exposure-label.level5 { color:#7c3aed; font-weight:600; }

    .sustain-badge {
      display:inline-block;
      margin-top:2px;
      padding:1px 6px;
      border-radius:999px;
      font-size:10px;
      background-color:#f97316;
      color:#fff;
    }

    @media (max-width: 600px) {
      h1 { font-size: 20px; }
      .card-body { font-size: 12px; }
      .title { font-size: 14px; }
      .filters { gap: 6px; }
      .filter-group { padding: 6px 8px; }
    }

    .footer {
      max-width: 1200px;
      margin: 0 auto 16px;
      padding: 0 16px;
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      margin-left: 4px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 10px;
      font-weight: 600;
      color: #9ca3af;
      background-color: #ffffff;
      cursor: default;
      position: relative;
    }
    .info-icon:hover {
      background-color: #f3f4f6;
      color: #4b5563;
    }
    .info-icon .tooltip-box {
      display: none;
      position: absolute;
      top: 18px;
      left: 0;
      transform: translateX(-20%);
      z-index: 100;
      background-color: #111827;
      color: #f9fafb;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 11px;
      line-height: 1.5;
      min-width: 220px;
      max-width: 320px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.35);
      white-space: normal;
    }
    .info-icon .tooltip-box::after {
      content: "";
      position: absolute;
      top: -5px;
      left: 22%;
      border-width: 5px;
      border-style: solid;
      border-color: transparent transparent #111827 transparent;
    }
    .info-icon:hover .tooltip-box {
      display: block;
    }

    .top10-heatmap-row {
      max-width: 1200px;
      margin: 12px auto 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }
    .top10-box {
      flex: 1 1 260px;
      padding: 16px 20px;
      border-radius: 12px;
      background: #e0f2fe;
      color: #0c4a6e;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .heatmap-box {
      flex: 1 1 340px;
      max-width: 100%;
      padding: 12px 12px 14px;
      background: #f9fafb;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(15,23,42,0.06);
    }
    .heatmap-title {
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 8px;
    }
    .heatmap-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      text-align: center;
      table-layout: fixed;
    }
    .heatmap-table th,
    .heatmap-table td {
      padding: 4px 2px;
      border-bottom: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      text-align: center;
      vertical-align: middle;
    }
    .heatmap-table th:last-child,
    .heatmap-table td:last-child { border-right: none; }
    .heatmap-table thead th {
      font-weight: 600;
      color: #4b5563;
      background-color: #eef2ff;
    }
    .heatmap-table tbody th {
      text-align: left;
      padding-left: 4px;
      background-color: #f3f4f6;
      color: #374151;
      white-space: nowrap;
    }
    .heatmap-cell {
      border-radius: 6px;
      min-width: 38px;
    }
    .heatmap-caption {
      margin-top: 6px;
      font-size: 11px;
      color: #6b7280;
      line-height: 1.5;
    }
    @media (max-width: 768px) {
      .top10-heatmap-row { flex-direction: column; }
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // =============================
    // ë¡œê·¸ì¸ ê²Œì´íŠ¸ (ìµœìš°ì„ )
    // =============================
    window.__currentUser = null;

    async function requireLoginOrRedirect() {
      try {
        const res = await fetch("/.netlify/functions/me", { credentials: "include" });
        const data = await res.json().catch(() => ({}));
        if (!data || !data.loggedIn) {
          location.replace("/login.html?redirect=/tool.html");
          return null;
        }
        window.__currentUser = data.user || null; // {id, name}
        return window.__currentUser;
      } catch (e) {
        location.replace("/login.html?redirect=/tool.html");
        return null;
      }
    }
    function getCurrentUser() {
      return window.__currentUser;
    }

    // =============================
    // ë¡œì»¬ ì €ì¥ ê´€ë ¨ (APIí‚¤/íˆìŠ¤í† ë¦¬)
    // =============================
    const API_KEY_STORAGE_PREFIX  = "yt_api_key_";
    const API_META_STORAGE_PREFIX = "yt_api_meta_";
    const HISTORY_STORAGE_PREFIX  = "yt_history_";

    const ENC_PREFIX = "enc1:";
    const ENC_SECRET = "CREBIZ_YT_TOOL_SALT";

    function encryptApiKey(plain) {
      if (!plain) return "";
      let out = "";
      for (let i = 0; i < plain.length; i++) {
        const code = plain.charCodeAt(i) ^ ENC_SECRET.charCodeAt(i % ENC_SECRET.length);
        out += String.fromCharCode(code);
      }
      return ENC_PREFIX + btoa(out);
    }
    function decryptApiKey(payload) {
      if (!payload) return "";
      if (!payload.startsWith(ENC_PREFIX)) return payload; // êµ¬ë²„ì „ í˜¸í™˜
      const b64 = payload.slice(ENC_PREFIX.length);
      const raw = atob(b64);
      let out = "";
      for (let i = 0; i < raw.length; i++) {
        const code = raw.charCodeAt(i) ^ ENC_SECRET.charCodeAt(i % ENC_SECRET.length);
        out += String.fromCharCode(code);
      }
      return out;
    }

    function getApiKeyStorageKey() {
      const user = getCurrentUser();
      const uid = user && user.id ? user.id : "default";
      return API_KEY_STORAGE_PREFIX + uid;
    }
    function getApiMetaStorageKey() {
      const user = getCurrentUser();
      const uid = user && user.id ? user.id : "default";
      return API_META_STORAGE_PREFIX + uid;
    }
    function getHistoryStorageKey() {
      const user = getCurrentUser();
      const uid = user && user.id ? user.id : "default";
      return HISTORY_STORAGE_PREFIX + uid;
    }

    function getStoredApiKeyDecrypted() {
      const keyName = getApiKeyStorageKey();
      const enc = localStorage.getItem(keyName);
      if (!enc) return "";
      return decryptApiKey(enc);
    }
  </script>
</head>

<body>

<!-- ğŸ”µ ìƒë‹¨ ìš°ì¸¡: ì¸ì‚¬ë§ + ì„¤ì • + ë¡œê·¸ì•„ì›ƒ -->
<div style="display:flex; justify-content:flex-end; align-items:center; gap:8px; margin-top:10px; padding:0 16px;">
  <span id="userGreeting" style="font-size:12px; color:#6b7280;"></span>
  <button id="settingsBtn" style="
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    background-color: #ffffff;
    cursor: pointer;
    color: #374151;
  ">ì„¤ì •</button>
  <button id="logoutBtn" style="
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    background-color: #f9fafb;
    cursor: pointer;
    color: #4b5563;
  ">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<!-- âœ… ë¡œê·¸ì¸ í™•ì¸ ëë‚œ ë’¤ì—ë§Œ ë³´ì—¬ì¤„ ë³¸ë¬¸ -->
<div id="appRoot" style="display:none;">

  <div class="container">
    <h1>CreBiz YouTube Analytics Tool</h1>

    <div id="settingsArea">
      <p class="note">
        YouTube ë°ì´í„°ëŠ” <strong>ê³µì‹ API</strong>ë¥¼ í†µí•´ <strong>ì‹¤ì‹œê°„</strong>ìœ¼ë¡œ ì¡°íšŒë©ë‹ˆë‹¤. <br />
        ê³µì‹ APIë¥¼ ì‚¬ìš©í•˜ë©´ ë¹„ê³µì‹ í¬ë¡¤ë§ ë°©ì‹ë³´ë‹¤ <strong>í›¨ì”¬ ì •í™•í•˜ê³  ì•ˆì •ì </strong>ì´ë¯€ë¡œ,
        API Key ì¸ì¦ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.<br />
        ì €ì¥ëœ API í‚¤ëŠ” <strong>ì‚¬ìš©ìì˜ ê°œì¸ ì¥ì¹˜</strong>ì—ë§Œ ì €ì¥ë˜ë©°, ì™¸ë¶€ ì„œë²„ë¡œë„ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </p>

      <div id="settingsPanel">
        <div class="api-key-box">
          <label for="apiKeyInput">YouTube API Key:</label>
          <input
            type="password"
            id="apiKeyInput"
            placeholder="ë°œê¸‰ë°›ì€ YouTube Data API v3 í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          />
          <button id="saveApiKeyBtn">ì €ì¥</button>
          <button id="howToBtn">ğŸ”¥ ì‚¬ìš©ë°©ë²• ì•ˆë‚´</button>
        </div>
        <div id="apiKeyMeta"></div>
      </div>
    </div>

    <div id="search-form">
      <input
        type="text"
        id="queryInput"
        placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì£¼ë°©í…œ, ìˆ˜ë‚©, ë¸Œì´ë¡œê·¸)"
      />
      <button id="searchBtn">ê²€ìƒ‰</button>
    </div>

    <div class="filters-row">
      <div class="filters">
        <div class="filter-group">
          <label for="lengthFilter">ì˜ìƒ ê¸¸ì´</label>
          <select id="lengthFilter">
            <option value="all">ì „ì²´</option>
            <option value="short">ìˆí¼ (&lt; 1ë¶„)</option>
            <option value="long">ë¡±í¼ (â‰¥ 1ë¶„)</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="dateFilter">ì—…ë¡œë“œ ê¸°ê°„</label>
          <select id="dateFilter">
            <option value="1m">1ê°œì›” ì´ë‚´</option>
            <option value="3m">3ê°œì›” ì´ë‚´</option>
            <option value="6m">6ê°œì›” ì´ë‚´</option>
            <option value="1y">1ë…„ ì´ë‚´</option>
            <option value="all" selected>ì „ì²´</option>
          </select>
        </div>

        <div class="filter-group">
          <label>
            ê¸°ì—¬ë„
            <span class="info-icon">i
              <span class="tooltip-box">
                íŠ¹ì • ì˜ìƒì´ ì±„ë„ ì„±ì¥ì— ë¯¸ì¹œ ì˜í–¥ë ¥ì„ ìˆ˜ì¹˜í™”í•œ ì§€í‘œë¡œ,<br>
                ë†’ì€ ê¸°ì—¬ë„ì¼ìˆ˜ë¡ ì±„ë„ì„ í¬ê²Œ ì„±ì¥ì‹œí‚¨ ì£¼ì œì„ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
              </span>
            </span>
          </label>
          <div class="ratio-options">
            <label title="ì±„ë„ ì„±ì¥ì— ê¸°ì—¬í•œ ì •ë„ê°€ ë‚®ì€ í¸ì…ë‹ˆë‹¤."><input type="checkbox" class="ratio-checkbox" value="1" /> ë‚®ìŒ</label>
            <label title="ì±„ë„ ì„±ì¥ì— í‰ê· ì ì¸ ìˆ˜ì¤€ìœ¼ë¡œ ê¸°ì—¬í•œ í¸ì…ë‹ˆë‹¤."><input type="checkbox" class="ratio-checkbox" value="2" /> ë³´í†µ</label>
            <label title="ì±„ë„ ì„±ì¥ì— ê½¤ ì–‘í˜¸í•˜ê²Œ ê¸°ì—¬í•œ í¸ì…ë‹ˆë‹¤."><input type="checkbox" class="ratio-checkbox" value="3" /> ì–‘í˜¸</label>
            <label title="ì±„ë„ ì„±ì¥ì— ìš°ìˆ˜í•˜ê²Œ ê¸°ì—¬í•œ ì½˜í…ì¸ ì…ë‹ˆë‹¤."><input type="checkbox" class="ratio-checkbox" value="4" /> ìš°ìˆ˜</label>
            <label title="ì±„ë„ ì„±ì¥ì— ë§¤ìš° í¬ê²Œ ê¸°ì—¬í•œ, ê°•ë ¥í•œ ì½˜í…ì¸ ì…ë‹ˆë‹¤."><input type="checkbox" class="ratio-checkbox" value="5" /> ë§¤ìš° ìš°ìˆ˜</label>
          </div>
          <button type="button" id="ratioResetBtn" class="ratio-reset-btn">ì „ì²´</button>
        </div>

        <div class="filter-group">
          <label>
            ë…¸ì¶œ í™•ë¥ 
            <span class="info-icon">i
              <span class="tooltip-box">
                ì˜ìƒì´ ì§€ê¸ˆ ì´ ì‹œì ì—ì„œ ìœ íŠœë¸Œ ì•Œê³ ë¦¬ì¦˜ ì¶”ì²œì„ ë°›ì„ ê°€ëŠ¥ì„±ì„ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œì…ë‹ˆë‹¤.<br>
                ë‹¨ê¸°ì ì¸ â€˜ì‹¤ì‹œê°„ í™•ì‚°ë ¥â€™ì„ íŒë‹¨í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
              </span>
            </span>
          </label>
          <div class="exposure-options">
            <label title="ì§€ê¸ˆì€ ì¶”ì²œ ê°€ëŠ¥ì„±ì´ ë‚®ì€ í¸ì…ë‹ˆë‹¤."><input type="checkbox" class="exposure-checkbox" value="1" /> ë‚®ìŒ</label>
            <label title="ë³´í†µ ìˆ˜ì¤€ì˜ ë…¸ì¶œ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤."><input type="checkbox" class="exposure-checkbox" value="2" /> ë³´í†µ</label>
            <label title="ê½¤ ì•ˆì •ì ìœ¼ë¡œ ë…¸ì¶œë˜ëŠ” í¸ì…ë‹ˆë‹¤."><input type="checkbox" class="exposure-checkbox" value="3" /> ì–‘í˜¸</label>
            <label title="ì•Œê³ ë¦¬ì¦˜ì— ì˜ ì¡íˆëŠ” í¸ì…ë‹ˆë‹¤."><input type="checkbox" class="exposure-checkbox" value="4" /> ë†’ìŒ</label>
            <label title="ì§€ì†ì ìœ¼ë¡œ ê°•í•˜ê²Œ ë…¸ì¶œë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤."><input type="checkbox" class="exposure-checkbox" value="5" /> ë§¤ìš° ë†’ìŒ</label>
          </div>
          <button type="button" id="exposureResetBtn" class="ratio-reset-btn">ì „ì²´</button>
        </div>

        <div class="filter-group">
          <label>êµ¬ë…ì ìˆ˜</label>
          <div style="display:flex; align-items:center; gap:4px;">
            <input type="number" id="subsMinInput" placeholder="ìµœì†Œ" min="0" style="width:80px; padding:4px 6px; font-size:12px;" />
            <span style="font-size:12px; color:#666;">~</span>
            <input type="number" id="subsMaxInput" placeholder="ìµœëŒ€" min="0" style="width:80px; padding:4px 6px; font-size:12px;" />
          </div>
        </div>

        <div class="filter-group">
          <label>
            ì§€ì† ì„±ì¥
            <span class="info-icon">i
              <span class="tooltip-box">
                ì—…ë¡œë“œ ì´í›„ ì‹œê°„ì´ ì§€ë‚˜ë„ ê¾¸ì¤€íˆ ì¡°íšŒìˆ˜ê°€ ìŒ“ì´ëŠ” ì˜ìƒì¸ì§€ ë³´ì—¬ì£¼ëŠ” ì§€í‘œì…ë‹ˆë‹¤.<br>
                ì¥ê¸°ì ìœ¼ë¡œ ì£½ì§€ ì•Šê³  ìœ ì§€ë˜ëŠ” â€˜ì•ˆì •ì  ì„±ì¥ë ¥â€™ì„ í‰ê°€í•©ë‹ˆë‹¤.
              </span>
            </span>
          </label>
          <div style="display:flex; align-items:center; gap:4px; font-size:12px;">
            <input type="checkbox" id="sustainOnlyCheckbox" />
            <span>ì§€ì† ì„±ì¥ ì˜ìƒë§Œ</span>
          </div>
        </div>
      </div>

      <div class="view-export-group">
        <div class="view-toggle">
          <button type="button" id="cardViewBtn" class="view-btn active">ì¹´ë“œ ë³´ê¸°</button>
          <button type="button" id="tableViewBtn" class="view-btn">í…Œì´ë¸” ë³´ê¸°</button>
        </div>
        <button type="button" id="exportBtn">ì—‘ì…€ë¡œ ì €ì¥</button>
      </div>
    </div>

    <div style="margin-top:12px; margin-bottom:4px;">
      <canvas
        id="ratioChart"
        style="
          max-width:480px;
          margin:0 auto;
          display:block;
          background:#fff;
          padding:12px 12px 16px;
          border-radius:12px;
          box-shadow:0 2px 6px rgba(0,0,0,0.06);
        "
      ></canvas>
    </div>

    <div class="top10-heatmap-row">
      <div id="top10Box" class="top10-box" style="display:none;">
        <h3 style="margin:0 0 12px; font-size:16px; font-weight:700; color:#075985;">
          ğŸ”¥ ì¶”ì²œ í‚¤ì›Œë“œ TOP10
        </h3>
        <ul id="top10List" style="margin:0; padding-left:16px; font-size:14px; line-height:1.6;"></ul>
      </div>

      <div id="heatmapContainer" class="heatmap-box" style="display:none;">
        <div class="heatmap-title">ê¸°ì—¬ë„ Ã— ë…¸ì¶œí™•ë¥  íˆíŠ¸ë§µ</div>
        <table class="heatmap-table">
          <thead>
            <tr>
              <th></th>
              <th>ë…¸ì¶œ í™•ë¥ <br>ë‚®ìŒ</th>
              <th>ë…¸ì¶œ í™•ë¥ <br>ë³´í†µ</th>
              <th>ë…¸ì¶œ í™•ë¥ <br>ì–‘í˜¸</th>
              <th>ë…¸ì¶œ í™•ë¥ <br>ë†’ìŒ</th>
              <th>ë…¸ì¶œ í™•ë¥ <br>ë§¤ìš° ë†’ìŒ</th>
            </tr>
          </thead>
          <tbody id="heatmapBody"></tbody>
        </table>
        <div class="heatmap-caption">
          ì§„í•œ ìƒ‰ì¼ìˆ˜ë¡ í•´ë‹¹ ì¡°í•©ì˜ ì˜ìƒì´ ë§ì´ ë¶„í¬í•´ ìˆë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <div id="status"></div>
    <div id="error"></div>
    <div id="results" class="results"></div>
  </div>

  <footer class="footer" style="text-align:left; padding:20px 0 40px 20px; line-height:1.6;">
    <div>
      <span style="font-weight:700; font-size:15px;">
        <a href="https://crebiz.art" target="_blank" style="color:inherit; text-decoration:none;">
          ë“œë¦¼ì‰ì–´ ì£¼ì‹íšŒì‚¬
        </a>
      </span>
      <br /><br />

      ëŒ€í‘œ: ê°•ì„±í˜„<br />
      ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸: 870-81-03268<br />
      í†µì‹ íŒë§¤ì—… ì‹ ê³ : ì œ 2025-ì¶©ë‚¨ì²œì•ˆ-0031í˜¸<br />
      ê°œì¸ì •ë³´ê´€ë¦¬ ì±…ì„ì: ê°•ì„±í˜„<br />
      ë©”ì¼: admin@crebiz.art<br />
      ì‚¬ì´íŠ¸:
      <a href="https://crebiz.art" target="_blank" style="color:inherit; text-decoration:none;">
        https://crebiz.art
      </a><br />
      CreBiz Youtube Analytics Tool ì„œë¹„ìŠ¤ëŠ” ì •ë³´ë§Œì„ ì œê³µí•  ë¿ ì •ë³´ í™œìš©ì— ëŒ€í•œ ì–´ë– í•œ ì±…ì„ì´ë‚˜ ì˜ë¬´ë¥¼ ë¶€ë‹´í•˜ì§€ ì•ŠìŒì„ ëª…ì‹œì ìœ¼ë¡œ ì•Œë¦½ë‹ˆë‹¤.
    </div>

    <br />
    <span style="font-weight:700; font-size:12px;">
      Â© 2025 DreamShare Inc. All rights reserved.
    </span>
  </footer>
</div>

<!-- ==== YouTube API Key ì‚¬ìš©ë°©ë²• ì•ˆë‚´ íŒì—… ==== -->
<div id="popupBg" style="
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.55); backdrop-filter:blur(2px);
  z-index:9998;
"></div>

<div id="popupWindow" style="
  display:none; position:fixed; top:50%; left:50%;
  transform:translate(-50%, -50%);
  width:90%; max-width:480px; max-height:80vh;
  background:#ffffff; border-radius:16px; padding:0 18px 22px;
  overflow-y:auto; box-shadow:0 18px 40px rgba(15,23,42,0.3);
  z-index:9999; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
">
  <div style="background:linear-gradient(135deg,#ef4444,#f97316); margin:0 -18px 16px; padding:18px 22px 16px; border-radius:16px 16px 0 0; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,0.25);">
    <div style="display:flex; align-items:center; gap:10px; justify-content:center;">
      <div style="width:32px; height:32px; border-radius:999px; background:rgba(255,255,255,0.18); display:flex; align-items:center; justify-content:center; font-size:20px;">âš™ï¸</div>
      <div style="text-align:left;">
        <div style="font-size:13px; opacity:0.9;">CreBiz Analytics Tool Â· YouTube</div>
        <h2 style="margin:2px 0 0; font-size:18px; font-weight:700;">YouTube API Key ìƒì„± ê°€ì´ë“œ</h2>
      </div>
    </div>
  </div>

  <div style="font-size:14px; line-height:1.7; margin-top:12px;">
    <p class="note">
      YouTube ë°ì´í„°ëŠ” <strong>ê³µì‹ API</strong>ë¥¼ í†µí•´ <strong>ì‹¤ì‹œê°„</strong>ìœ¼ë¡œ ì¡°íšŒë©ë‹ˆë‹¤. <br />
      ê³µì‹ APIë¥¼ ì‚¬ìš©í•˜ë©´ ë¹„ê³µì‹ í¬ë¡¤ë§ ë°©ì‹ë³´ë‹¤ <strong>í›¨ì”¬ ì •í™•í•˜ê³  ì•ˆì •ì </strong>ì´ë¯€ë¡œ,<br />
      API Key ì¸ì¦ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.<br />
      API í‚¤ëŠ” <strong>ì‚¬ìš©ìì˜ ê°œì¸ ì¥ì¹˜</strong>ì—ë§Œ ì €ì¥ë˜ë©°, ì™¸ë¶€ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </p>

    <p><b>â‘  Google Cloud Platform(GCP) ì ‘ì†</b><br>
    ğŸ‘‰ <a href="https://console.cloud.google.com/" target="_blank" rel="noopener noreferrer">https://console.cloud.google.com/</a></p>

    <p><b>â‘¡ ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</b><br>
    í”„ë¡œì íŠ¸ ì´ë¦„ì€ ì•„ë¬´ê±°ë‚˜ ê°€ëŠ¥ (ì˜ˆ: <code>YouTubeTool</code>)</p>

    <p><b>â‘¢ ì™¼ìª½ ë©”ë‰´ â†’ <code>API ë° ì„œë¹„ìŠ¤</code> â†’ <code>ë¼ì´ë¸ŒëŸ¬ë¦¬</code></b></p>

    <p><b>â‘£ ê²€ìƒ‰ì°½ì— â€œYouTube Data API v3â€ ì…ë ¥ í›„</b><br>
    â†’ ê²°ê³¼ì—ì„œ ì„ íƒ â†’ <b>í™œì„±í™”(Enable)</b> ë²„íŠ¼ í´ë¦­</p>

    <p><b>â‘¤ ì™¼ìª½ ë©”ë‰´ â†’ <code>ì‚¬ìš©ì ì¸ì¦ ì •ë³´(Credentials)</code></b></p>

    <p><b>â‘¥ ìƒë‹¨ì˜ <code>ì‚¬ìš©ì ì¸ì¦ ì •ë³´ ë§Œë“¤ê¸°(Create credentials)</code> í´ë¦­ â†’</b><br>
    <b>API í‚¤(API key)</b> ì„ íƒ</p>

    <p><b>â‘¦ ìƒì„±ëœ API í‚¤ë¥¼ ë³µì‚¬ â†’</b><br>
    ì´ íˆ´ ìƒë‹¨ì˜ <b>YouTube API Key</b> ì…ë ¥ë€ì— ë¶™ì—¬ë„£ê³  â†’ <b>[ì €ì¥]</b> í´ë¦­</p>

    <p style="margin-top:12px; font-size:13px; color:#555;">
      â€» API í‚¤ëŠ” ì´ ì‚¬ìš©ìì˜ ê¸°ê¸°ì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br><br>
      <b>Chrome ë¸Œë¼ìš°ì €ì—ì„œ ì‚­ì œ ë°©ë²•:</b><br>
      1) ìš°ì¸¡ ìƒë‹¨ â€˜â‹®â€™ ë©”ë‰´ â†’ <b>ì„¤ì •</b><br>
      2) <b>ê°œì¸ì •ë³´ ë° ë³´ì•ˆ</b> â†’ <b>ì¸í„°ë„· ì‚¬ìš© ê¸°ë¡ ì‚­ì œ</b><br>
      3) ì•„ë˜ í•­ëª© ì„ íƒ:<br>
      - ì¸í„°ë„· ì‚¬ìš© ê¸°ë¡<br>
      - ì¿ í‚¤ ë° ê¸°íƒ€ ì‚¬ì´íŠ¸ ë°ì´í„°<br>
      - ìºì‹œëœ ì´ë¯¸ì§€ ë° íŒŒì¼<br>
      4) ê¸°ê°„: <b>ì „ì²´ ê¸°ê°„</b><br>
      5) <b>ë°ì´í„° ì‚­ì œ</b> í´ë¦­
    </p>
  </div>

  <div style="margin-top:14px; font-size:13px; color:#444; display:flex; align-items:center; gap:6px;">
    <input type="checkbox" id="dontShowAgain" style="cursor:pointer;" />
    <label for="dontShowAgain" style="cursor:pointer;">ë‹¤ìŒë¶€í„° ì´ ì•ˆë‚´ë¥¼ ìë™ìœ¼ë¡œ ë„ìš°ì§€ ì•Šê¸°</label>
  </div>

  <button id="closePopupBtn"
          style="margin-top:18px; width:100%; padding:10px;
                 font-size:15px; border:none; border-radius:8px;
                 background:#111827; color:#fff; cursor:pointer; font-weight:600;">
    ë‹«ê¸°
  </button>
</div>

<script>
  // =============================
  // ì•„ë˜ë¶€í„° ì•± ë³¸ ë¡œì§
  // (ì¤‘ìš”) DOMContentLoadedëŠ” 1ë²ˆë§Œ!
  // =============================
  const API_BASE_URL = "https://www.googleapis.com/youtube/v3";

  let allVideos = [];
  let filteredVideos = [];
  let currentViewMode = "card";
  let currentSort = { key: null, dir: null };
  let ratioChart = null;
  let top10Keywords = [];

  function setStatus(message, isLoading = false) {
    const statusEl = document.getElementById("status");
    if (!statusEl) return;
    if (!message) { statusEl.innerHTML = ""; return; }
    if (isLoading) {
      statusEl.innerHTML = '<span class="loading-spinner"></span><span>' + message + "</span>";
    } else {
      statusEl.textContent = message;
    }
  }
  function setError(message) {
    const errorEl = document.getElementById("error");
    if (!errorEl) return;
    errorEl.textContent = message || "";
  }
  function clearResults() {
    const resultsEl = document.getElementById("results");
    if (!resultsEl) return;
    resultsEl.innerHTML = "";
  }

  function formatNumberWithCommas(numStr) {
    if (numStr === undefined || numStr === null || numStr === "") return "ì •ë³´ ì—†ìŒ";
    const num = Number(numStr);
    if (Number.isNaN(num)) return "ì •ë³´ ì—†ìŒ";
    return num.toLocaleString("en-US");
  }

  function getDateFilterRange(option) {
    const now = new Date();
    let monthsToSubtract = 0;
    switch (option) {
      case "1m": monthsToSubtract = 1; break;
      case "3m": monthsToSubtract = 3; break;
      case "6m": monthsToSubtract = 6; break;
      case "1y": monthsToSubtract = 12; break;
      case "all":
      default: return { thresholdDate: null, publishedAfter: null };
    }
    const thresholdDate = new Date(now);
    thresholdDate.setMonth(thresholdDate.getMonth() - monthsToSubtract);
    return { thresholdDate, publishedAfter: thresholdDate.toISOString() };
  }

  function parseDurationToSeconds(duration) {
    if (!duration || typeof duration !== "string") return 0;
    const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
    if (!match) return 0;
    const h = parseInt(match[1] || "0", 10);
    const m = parseInt(match[2] || "0", 10);
    const s = parseInt(match[3] || "0", 10);
    return h * 3600 + m * 60 + s;
  }

  function formatDuration(totalSeconds) {
    if (!totalSeconds || totalSeconds <= 0) return "ì •ë³´ ì—†ìŒ";
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    const pad = (n) => String(n).padStart(2, "0");
    if (h > 0) return `${h}:${pad(m)}:${pad(s)}`;
    return `${m}:${pad(s)}`;
  }

  function getRatioLevel(ratio) {
    if (ratio === null || ratio === undefined || Number.isNaN(ratio)) return null;
    if (ratio < 0.25) return 1;
    if (ratio < 0.75) return 2;
    if (ratio < 1.5)  return 3;
    if (ratio < 3)    return 4;
    return 5;
  }
  function getRatioLabel(level) {
    if (level === 1) return "ë‚®ìŒ";
    if (level === 2) return "ë³´í†µ";
    if (level === 3) return "ì–‘í˜¸";
    if (level === 4) return "ìš°ìˆ˜";
    if (level === 5) return "ë§¤ìš° ìš°ìˆ˜";
    return "ì •ë³´ ì—†ìŒ";
  }
  function getRatioDescription(level) {
    if (level === 1) return "ì±„ë„ ì„±ì¥ì— ê¸°ì—¬í•œ ì •ë„ê°€ ë‚®ì€ í¸ì…ë‹ˆë‹¤.";
    if (level === 2) return "ì±„ë„ ì„±ì¥ì— í‰ê· ì ì¸ ìˆ˜ì¤€ìœ¼ë¡œ ê¸°ì—¬í•œ í¸ì…ë‹ˆë‹¤.";
    if (level === 3) return "ì±„ë„ ì„±ì¥ì— ì–‘í˜¸í•˜ê²Œ ê¸°ì—¬í•œ í¸ì…ë‹ˆë‹¤.";
    if (level === 4) return "ì±„ë„ ì„±ì¥ì— ìš°ìˆ˜í•˜ê²Œ ê¸°ì—¬í•œ ì½˜í…ì¸ ì…ë‹ˆë‹¤.";
    if (level === 5) return "ì±„ë„ ì„±ì¥ì— ë§¤ìš° í¬ê²Œ ê¸°ì—¬í•œ, ê°•ë ¥í•œ ì½˜í…ì¸ ì…ë‹ˆë‹¤.";
    return "";
  }

  function getExposureLevel(score) {
    if (score === null || score === undefined || Number.isNaN(score)) return null;
    if (score < 0.3) return 1;
    if (score < 0.7) return 2;
    if (score < 1.2) return 3;
    if (score < 1.8) return 4;
    return 5;
  }
  function getExposureLabel(level) {
    if (level === 1) return "ë‚®ìŒ";
    if (level === 2) return "ë³´í†µ";
    if (level === 3) return "ì–‘í˜¸";
    if (level === 4) return "ë†’ìŒ";
    if (level === 5) return "ë§¤ìš° ë†’ìŒ";
    return "ì •ë³´ ì—†ìŒ";
  }
  function getExposureDescription(level) {
    if (level === 1) return "ì§€ê¸ˆì€ ì¶”ì²œÂ·ë…¸ì¶œ ê°€ëŠ¥ì„±ì´ ë‚®ì€ í¸ì…ë‹ˆë‹¤.";
    if (level === 2) return "ë³´í†µ ìˆ˜ì¤€ìœ¼ë¡œ ë…¸ì¶œë  ìˆ˜ ìˆëŠ” ì˜ìƒì…ë‹ˆë‹¤.";
    if (level === 3) return "ê¾¸ì¤€íˆ ë…¸ì¶œë˜ê¸° ì¢‹ì€ ì˜ìƒì…ë‹ˆë‹¤.";
    if (level === 4) return "ì•Œê³ ë¦¬ì¦˜ì— ì˜ ì¡í˜€ ë†’ì€ ë…¸ì¶œì´ ê¸°ëŒ€ë©ë‹ˆë‹¤.";
    if (level === 5) return "ì§€ì†ì ìœ¼ë¡œ ê°•í•˜ê²Œ ë…¸ì¶œë  ê°€ëŠ¥ì„±ì´ ë†’ì€ ì˜ìƒì…ë‹ˆë‹¤.";
    return "";
  }

  function getSelectedRatioLevels() {
    const checked = document.querySelectorAll(".ratio-checkbox:checked");
    return Array.from(checked).map((el) => Number(el.value));
  }
  function getSelectedExposureLevels() {
    const checked = document.querySelectorAll(".exposure-checkbox:checked");
    return Array.from(checked).map((el) => Number(el.value));
  }

  async function fetchSearchResults(apiKey, query, publishedAfter, pageToken) {
    let url = API_BASE_URL + "/search?part=snippet&type=video&maxResults=50&q=" +
      encodeURIComponent(query) + "&key=" + encodeURIComponent(apiKey);
    if (publishedAfter) url += "&publishedAfter=" + encodeURIComponent(publishedAfter);
    if (pageToken) url += "&pageToken=" + encodeURIComponent(pageToken);

    const res = await fetch(url);
    if (!res.ok) {
      let msg = "HTTP ì˜¤ë¥˜: " + res.status;
      try {
        const errData = await res.json();
        if (errData && errData.error && errData.error.message) msg = errData.error.message;
      } catch {}
      throw new Error(msg);
    }
    return res.json();
  }

  async function fetchVideoDetails(apiKey, videoIds) {
    if (!videoIds.length) return { items: [] };
    const allItems = [];
    const chunkSize = 50;

    for (let i = 0; i < videoIds.length; i += chunkSize) {
      const chunk = videoIds.slice(i, i + chunkSize);
      const url = API_BASE_URL + "/videos?part=snippet,statistics,contentDetails&id=" +
        encodeURIComponent(chunk.join(",")) + "&key=" + encodeURIComponent(apiKey);

      const res = await fetch(url);
      if (!res.ok) {
        let msg = "HTTP ì˜¤ë¥˜: " + res.status;
        try {
          const errData = await res.json();
          if (errData && errData.error && errData.error.message) msg = errData.error.message;
        } catch {}
        throw new Error(msg);
      }
      const data = await res.json();
      if (data.items && data.items.length) allItems.push(...data.items);
    }
    return { items: allItems };
  }

  async function fetchChannelDetails(apiKey, channelIds) {
    if (!channelIds.length) return { items: [] };
    const allItems = [];
    const chunkSize = 50;

    for (let i = 0; i < channelIds.length; i += chunkSize) {
      const chunk = channelIds.slice(i, i + chunkSize);
      const url = API_BASE_URL + "/channels?part=snippet,statistics&id=" +
        encodeURIComponent(chunk.join(",")) + "&key=" + encodeURIComponent(apiKey);

      const res = await fetch(url);
      if (!res.ok) {
        let msg = "HTTP ì˜¤ë¥˜: " + res.status;
        try {
          const errData = await res.json();
          if (errData && errData.error && errData.error.message) msg = errData.error.message;
        } catch {}
        throw new Error(msg);
      }
      const data = await res.json();
      if (data.items && data.items.length) allItems.push(...data.items);
    }
    return { items: allItems };
  }

  function updateApiMetaText() {
    const apiKeyMetaEl = document.getElementById("apiKeyMeta");
    if (!apiKeyMetaEl) return;
    const metaName = getApiMetaStorageKey();
    try {
      const raw = localStorage.getItem(metaName);
      if (!raw) { apiKeyMetaEl.textContent = ""; return; }
      const meta = JSON.parse(raw);
      if (!meta.updatedAt) { apiKeyMetaEl.textContent = ""; return; }
      const d = new Date(meta.updatedAt);
      if (Number.isNaN(d.getTime())) { apiKeyMetaEl.textContent = ""; return; }

      const yyyy = d.getFullYear();
      const mm   = String(d.getMonth() + 1).padStart(2, "0");
      const dd   = String(d.getDate()).padStart(2, "0");
      const hh   = String(d.getHours()).padStart(2, "0");
      const mi   = String(d.getMinutes()).padStart(2, "0");
      apiKeyMetaEl.textContent = `API í‚¤ ë§ˆì§€ë§‰ ìˆ˜ì •: ${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    } catch {
      apiKeyMetaEl.textContent = "";
    }
  }

  function saveApiKeyToStorage(key) {
    const trimmed = (key || "").trim();
    if (!trimmed) { alert("ë¹ˆ ê°’ì€ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

    const keyName  = getApiKeyStorageKey();
    const metaName = getApiMetaStorageKey();

    localStorage.setItem(keyName, encryptApiKey(trimmed));
    localStorage.setItem(metaName, JSON.stringify({ updatedAt: new Date().toISOString() }));

    updateApiMetaText();
    alert("API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ê²€ìƒ‰ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

    const settingsArea = document.getElementById("settingsArea");
    if (settingsArea) settingsArea.style.display = "none";
  }

  function saveSearchHistory(query) {
    if (!query || !query.trim()) return;
    const key = getHistoryStorageKey();
    let arr = [];
    try { arr = JSON.parse(localStorage.getItem(key) || "[]") || []; } catch { arr = []; }
    arr.unshift({ q: query.trim(), t: new Date().toISOString() });
    if (arr.length > 20) arr = arr.slice(0, 20);
    try { localStorage.setItem(key, JSON.stringify(arr)); } catch {}
  }

  function computeExposureAndSustain(videos) {
    if (!videos || !videos.length) return;

    const sustainCandidate = [];
    videos.forEach(v => {
      if (v.daysSincePublished != null && v.daysSincePublished >= 90 && v.viewsPerDay != null && v.viewsPerDay > 0) {
        sustainCandidate.push(v.viewsPerDay);
      }
    });

    let sustainThreshold = null;
    if (sustainCandidate.length) {
      sustainCandidate.sort((a,b)=>b-a);
      let idx = Math.floor(sustainCandidate.length * 0.25) - 1;
      if (idx < 0) idx = 0;
      sustainThreshold = sustainCandidate[idx];
    }

    videos.forEach(v => {
      v.isSustained = false;
      if (sustainThreshold != null && v.daysSincePublished != null && v.daysSincePublished >= 90 && v.viewsPerDay != null && v.viewsPerDay >= sustainThreshold) {
        v.isSustained = true;
      }

      const ratioValue = (v.ratio != null && !Number.isNaN(v.ratio)) ? Number(v.ratio) : 0;
      const ratioNormalized = Math.min(Math.max(ratioValue / 1.5, 0), 2);

      const days = v.daysSincePublished != null ? v.daysSincePublished : null;
      let recentFactor = 1;
      if (days == null) recentFactor = 1;
      else if (days <= 7) recentFactor = 1.3;
      else if (days <= 30) recentFactor = 1.15;
      else if (days <= 90) recentFactor = 1.0;
      else if (days <= 365) recentFactor = 0.7;
      else recentFactor = 0.4;

      const sustainBoost = v.isSustained ? 1.2 : 1.0;

      const exposureScore = ratioNormalized * recentFactor * sustainBoost;
      v.exposureScore = exposureScore;
      v.exposureLevel = getExposureLevel(exposureScore);
    });
  }

  function updateTop10Keywords() {
    const source = filteredVideos.length ? filteredVideos : allVideos;
    const box = document.getElementById("top10Box");
    const list = document.getElementById("top10List");
    if (!box || !list) return;

    if (!source || !source.length) {
      box.style.display = "none";
      list.innerHTML = "";
      top10Keywords = [];
      return;
    }

    const counts = new Map();
    source.forEach(v => {
      const baseScore = (v.ratioLevel || 0) + (v.exposureLevel || 0) + (v.isSustained ? 1 : 0);
      const weight = Math.max(1, baseScore);

      const titleWords = (v.title || "")
        .split(/[\s\|\#\[\]\(\),\.\/]+/)
        .map(w => w.trim())
        .filter(w => w.length >= 2);

      const tagWords = (v.tags || []).map(t => t.trim()).filter(Boolean);
      const allWords = [...titleWords, ...tagWords];

      allWords.forEach(w => {
        const ban = ["ì˜ìƒ", "ì¡°íšŒìˆ˜", "ë¸Œì´ë¡œê·¸", "ì¼ìƒ", "ê¸°ë¡", "ì±„ë„"];
        if (ban.includes(w)) return;

        const prev = counts.get(w) || { score: 0, count: 0 };
        prev.score += weight;
        prev.count += 1;
        counts.set(w, prev);
      });
    });

    top10Keywords = Array.from(counts.entries())
      .map(([word, info]) => ({ word, score: info.score, count: info.count }))
      .sort((a,b)=> (b.score - a.score) || (b.count - a.count))
      .slice(0,10);

    box.style.display = top10Keywords.length ? "block" : "none";
    list.innerHTML = top10Keywords.map((item, idx) =>
      `<li>${idx + 1}. ${item.word} Â· TOP ì˜ìƒ ${item.count}ê°œì—ì„œ ë“±ì¥</li>`
    ).join("");
  }

  function updateRatioChart() {
    const dataSource = filteredVideos.length ? filteredVideos : allVideos;

    const labels = ["ë‚®ìŒ", "ë³´í†µ", "ì–‘í˜¸", "ìš°ìˆ˜", "ë§¤ìš° ìš°ìˆ˜"];
    const counts = [0, 0, 0, 0, 0];

    (dataSource || []).forEach(v => {
      if (v.ratioLevel && v.ratioLevel >= 1 && v.ratioLevel <= 5) counts[v.ratioLevel - 1]++;
    });

    const canvas = document.getElementById("ratioChart");
    if (!canvas || typeof Chart === "undefined") return;
    const ctx = canvas.getContext("2d");

    const data = {
      labels,
      datasets: [{
        label: "ê¸°ì—¬ë„ ë¶„í¬ (ì˜ìƒ ìˆ˜)",
        data: counts,
        backgroundColor: ["#9ca3af","#6b7280","#2563eb","#dc2626","#b91c1c"]
      }]
    };

    const options = {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function (context) {
              const label = labels[context.dataIndex] || "";
              const value = context.parsed.y || 0;
              return label + ": " + value + "ê°œ";
            }
          }
        }
      },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    };

    if (ratioChart) { ratioChart.data = data; ratioChart.options = options; ratioChart.update(); }
    else { ratioChart = new Chart(ctx, { type: "bar", data, options }); }
  }

  function updateHeatmap() {
    const container = document.getElementById("heatmapContainer");
    const body = document.getElementById("heatmapBody");
    if (!container || !body) return;

    const dataSource = filteredVideos.length ? filteredVideos : allVideos;
    const matrix = Array.from({ length: 5 }, () => Array(5).fill(0));
    let totalValid = 0;

    (dataSource || []).forEach(v => {
      const r = v.ratioLevel, e = v.exposureLevel;
      if (r != null && e != null && r>=1 && r<=5 && e>=1 && e<=5) {
        matrix[r-1][e-1] += 1;
        totalValid++;
      }
    });

    if (!totalValid) { container.style.display = "none"; body.innerHTML = ""; return; }
    container.style.display = "block";

    let maxCount = 0;
    for (let i=0;i<5;i++) for (let j=0;j<5;j++) maxCount = Math.max(maxCount, matrix[i][j]);
    if (maxCount === 0) { container.style.display = "none"; body.innerHTML = ""; return; }

    const ratioLabels = ["ê¸°ì—¬ë„ ë‚®ìŒ","ê¸°ì—¬ë„ ë³´í†µ","ê¸°ì—¬ë„ ì–‘í˜¸","ê¸°ì—¬ë„ ìš°ìˆ˜","ê¸°ì—¬ë„ ë§¤ìš° ìš°ìˆ˜"];
    body.innerHTML = "";

    for (let r=0;r<5;r++) {
      const tr = document.createElement("tr");
      const th = document.createElement("th");
      th.textContent = ratioLabels[r];
      tr.appendChild(th);

      for (let e=0;e<5;e++) {
        const count = matrix[r][e];
        const td = document.createElement("td");
        td.className = "heatmap-cell";
        if (count > 0) {
          const ratio = count / maxCount;
          const alpha = 0.18 + 0.65 * ratio;
          td.style.backgroundColor = "rgba(37, 99, 235, " + alpha.toFixed(2) + ")";
          td.style.color = alpha > 0.55 ? "#f9fafb" : "#111827";
          td.textContent = count + "ê°œ";
        } else {
          td.style.backgroundColor = "rgba(148, 163, 184, 0.06)";
          td.style.color = "#6b7280";
          td.textContent = "-";
        }
        tr.appendChild(td);
      }
      body.appendChild(tr);
    }
  }

  function renderCards(videos) {
    const resultsEl = document.getElementById("results");
    clearResults();
    if (!resultsEl) return;

    if (!videos.length) { resultsEl.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>'; return; }

    const grid = document.createElement("div");
    grid.className = "card-grid";

    videos.forEach(v => {
      const card = document.createElement("div");
      card.className = "card";

      const thumbWrapper = document.createElement("div");
      thumbWrapper.className = "thumbnail-wrapper";
      if (v.thumbnailUrl) {
        const img = document.createElement("img");
        img.src = v.thumbnailUrl;
        img.alt = v.title || "";
        thumbWrapper.appendChild(img);
      }

      const body = document.createElement("div");
      body.className = "card-body";

      const titleEl = document.createElement("h2");
      titleEl.className = "title";
      const titleLink = document.createElement("a");
      titleLink.href = "https://www.youtube.com/watch?v=" + v.videoId;
      titleLink.target = "_blank";
      titleLink.rel = "noopener noreferrer";
      titleLink.textContent = v.title || "ì œëª© ì •ë³´ ì—†ìŒ";
      titleEl.appendChild(titleLink);

      const metaRow = document.createElement("div");
      metaRow.className = "meta-row";

      const channelItem = document.createElement("div");
      channelItem.className = "meta-item";
      channelItem.innerHTML = '<span class="label">ì±„ë„:</span> <span>' + (v.channelTitle || "ì±„ë„ ì •ë³´ ì—†ìŒ") + "</span>";

      const subsItem = document.createElement("div");
      subsItem.className = "meta-item";
      subsItem.innerHTML = '<span class="label">êµ¬ë…ì:</span> <span>' + v.subscriberCountFormatted + "</span>";

      const viewsItem = document.createElement("div");
      viewsItem.className = "meta-item";
      viewsItem.innerHTML = '<span class="label">ì¡°íšŒìˆ˜:</span> <span>' + v.viewCountFormatted + "</span>";

      const durationItem = document.createElement("div");
      durationItem.className = "meta-item";
      durationItem.innerHTML = '<span class="label">ê¸¸ì´:</span> <span>' + v.durationText + "</span>";

      const ratioItem = document.createElement("div");
      ratioItem.className = "meta-item";
      let ratioText = "ì •ë³´ ì—†ìŒ";
      if (v.ratio != null && !Number.isNaN(v.ratio)) {
        const label = getRatioLabel(v.ratioLevel);
        const desc = getRatioDescription(v.ratioLevel);
        if (label !== "ì •ë³´ ì—†ìŒ") ratioText = `<span class="ratio-label level${v.ratioLevel}" title="${desc}">${label}</span>`;
      }
      ratioItem.innerHTML = '<span class="label">ê¸°ì—¬ë„:</span> <span>' + ratioText + "</span>";

      const exposureItem = document.createElement("div");
      exposureItem.className = "meta-item";
      let exposureText = "ì •ë³´ ì—†ìŒ";
      if (v.exposureLevel != null) {
        const elabel = getExposureLabel(v.exposureLevel);
        const edesc = getExposureDescription(v.exposureLevel);
        if (elabel !== "ì •ë³´ ì—†ìŒ") exposureText = `<span class="exposure-label level${v.exposureLevel}" title="${edesc}">${elabel}</span>`;
      }
      if (v.isSustained) {
        exposureText += '<span class="sustain-badge" title="ì˜¤ë˜ì „ì— ì—…ë¡œë“œë˜ì—ˆì§€ë§Œ ì§€ê¸ˆë„ ê¾¸ì¤€íˆ ì¡°íšŒìˆ˜ê°€ ì˜¤ë¥´ëŠ” ì˜ìƒì…ë‹ˆë‹¤.">ì§€ì† ì„±ì¥</span>';
      }
      exposureItem.innerHTML = '<span class="label">ë…¸ì¶œí™•ë¥ :</span> <span>' + exposureText + "</span>";

      metaRow.appendChild(channelItem);
      metaRow.appendChild(subsItem);
      metaRow.appendChild(viewsItem);
      metaRow.appendChild(durationItem);
      metaRow.appendChild(ratioItem);
      metaRow.appendChild(exposureItem);

      body.appendChild(titleEl);
      body.appendChild(metaRow);

      if (v.tags && v.tags.length) {
        const tagsWrapper = document.createElement("div");
        tagsWrapper.className = "tags";
        v.tags.slice(0, 10).forEach(tag => {
          const tagEl = document.createElement("span");
          tagEl.className = "tag";
          tagEl.textContent = "#" + tag;
          tagsWrapper.appendChild(tagEl);
        });
        body.appendChild(tagsWrapper);
      }

      card.appendChild(thumbWrapper);
      card.appendChild(body);
      grid.appendChild(card);
    });

    resultsEl.appendChild(grid);
  }

  function renderTable(videos) {
    const resultsEl = document.getElementById("results");
    clearResults();
    if (!resultsEl) return;

    if (!videos.length) { resultsEl.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>'; return; }

    const wrapper = document.createElement("div");
    wrapper.className = "table-wrapper";

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");

    const addSortTh = (label, key) => {
      const th = document.createElement("th");
      th.textContent = label;
      const icons = document.createElement("span");
      icons.className = "sort-icons";

      const asc = document.createElement("button");
      asc.className = "sort-icon";
      asc.textContent = "â–²";
      asc.dataset.key = key;
      asc.dataset.dir = "asc";

      const desc = document.createElement("button");
      desc.className = "sort-icon";
      desc.textContent = "â–¼";
      desc.dataset.key = key;
      desc.dataset.dir = "desc";

      if (currentSort.key === key && currentSort.dir === "asc") asc.classList.add("active");
      if (currentSort.key === key && currentSort.dir === "desc") desc.classList.add("active");

      icons.appendChild(asc);
      icons.appendChild(desc);
      th.appendChild(icons);
      return th;
    };

    let th = document.createElement("th"); th.textContent = "ì¸ë„¤ì¼"; headerRow.appendChild(th);
    th = document.createElement("th"); th.textContent = "ì œëª©"; headerRow.appendChild(th);
    headerRow.appendChild(addSortTh("ì¡°íšŒìˆ˜","views"));
    headerRow.appendChild(addSortTh("êµ¬ë…ì","subs"));
    headerRow.appendChild(addSortTh("ê¸°ì—¬ë„","ratio"));
    headerRow.appendChild(addSortTh("ë…¸ì¶œí™•ë¥ ","exposure"));
    th = document.createElement("th"); th.textContent = "ê¸¸ì´"; headerRow.appendChild(th);
    th = document.createElement("th"); th.textContent = "ì—…ë¡œë“œì¼"; headerRow.appendChild(th);
    th = document.createElement("th"); th.textContent = "íƒœê·¸"; headerRow.appendChild(th);

    thead.appendChild(headerRow);
    const tbody = document.createElement("tbody");

    videos.forEach(v => {
      const tr = document.createElement("tr");

      const thumbTd = document.createElement("td");
      thumbTd.className = "thumbnail-cell";
      if (v.thumbnailUrl) {
        const img = document.createElement("img");
        img.src = v.thumbnailUrl;
        img.alt = v.title || "";
        thumbTd.appendChild(img);
      }
      tr.appendChild(thumbTd);

      const titleTd = document.createElement("td");
      titleTd.className = "title-cell";
      const titleLink = document.createElement("a");
      titleLink.href = "https://www.youtube.com/watch?v=" + v.videoId;
      titleLink.target = "_blank";
      titleLink.rel = "noopener noreferrer";
      titleLink.textContent = v.title || "ì œëª© ì •ë³´ ì—†ìŒ";
      titleTd.appendChild(titleLink);
      tr.appendChild(titleTd);

      const viewsTd = document.createElement("td");
      viewsTd.textContent = v.viewCountFormatted;
      tr.appendChild(viewsTd);

      const subsTd = document.createElement("td");
      subsTd.className = "subs-cell";
      subsTd.innerHTML =
        (v.subscriberCountFormatted || "") +
        (v.channelTitle && v.channelTitle !== "ì±„ë„ ì •ë³´ ì—†ìŒ"
          ? '<br/><span style="color:#666;">' + v.channelTitle + "</span>"
          : "");
      tr.appendChild(subsTd);

      const ratioTd = document.createElement("td");
      let ratioText = "ì •ë³´ ì—†ìŒ";
      if (v.ratio != null && !Number.isNaN(v.ratio)) {
        const label = getRatioLabel(v.ratioLevel);
        const desc = getRatioDescription(v.ratioLevel);
        if (label !== "ì •ë³´ ì—†ìŒ") ratioText = `<span class="ratio-label level${v.ratioLevel}" title="${desc}">${label}</span>`;
      }
      ratioTd.innerHTML = ratioText;
      tr.appendChild(ratioTd);

      const exposureTd = document.createElement("td");
      let exposureText = "ì •ë³´ ì—†ìŒ";
      if (v.exposureLevel != null) {
        const elabel = getExposureLabel(v.exposureLevel);
        const edesc = getExposureDescription(v.exposureLevel);
        if (elabel !== "ì •ë³´ ì—†ìŒ") exposureText = `<span class="exposure-label level${v.exposureLevel}" title="${edesc}">${elabel}</span>`;
      }
      if (v.isSustained) {
        exposureText += '<br/><span class="sustain-badge" title="ì˜¤ë˜ì „ì— ì—…ë¡œë“œë˜ì—ˆì§€ë§Œ ì§€ê¸ˆë„ ê¾¸ì¤€íˆ ì¡°íšŒìˆ˜ê°€ ì˜¤ë¥´ëŠ” ì˜ìƒì…ë‹ˆë‹¤.">ì§€ì† ì„±ì¥</span>';
      }
      exposureTd.innerHTML = exposureText;
      tr.appendChild(exposureTd);

      const durationTd = document.createElement("td");
      durationTd.textContent = v.durationText;
      tr.appendChild(durationTd);

      const dateTd = document.createElement("td");
      dateTd.textContent = v.publishedAtRaw ? v.publishedAtRaw.slice(0,10) : "ì •ë³´ ì—†ìŒ";
      tr.appendChild(dateTd);

      const tagsTd = document.createElement("td");
      tagsTd.className = "tags-cell";
      tagsTd.textContent = (v.tags && v.tags.length)
        ? v.tags.slice(0,15).map(t => "#" + t).join(", ")
        : "";
      tr.appendChild(tagsTd);

      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    wrapper.appendChild(table);
    resultsEl.appendChild(wrapper);

    wrapper.querySelectorAll(".sort-icon").forEach(btn => {
      btn.addEventListener("click", () => sortFiltered(btn.dataset.key, btn.dataset.dir));
    });
  }

  function renderCurrentView() {
    if (currentViewMode === "table") renderTable(filteredVideos);
    else renderCards(filteredVideos);
  }

  function sortFiltered(key, dir, rerender = true) {
    const factor = dir === "asc" ? 1 : -1;
    filteredVideos.sort((a,b) => {
      let av=0, bv=0;
      if (key === "views") {
        av = a.viewCountRaw ? Number(a.viewCountRaw) : 0;
        bv = b.viewCountRaw ? Number(b.viewCountRaw) : 0;
      } else if (key === "subs") {
        av = a.subscriberCountRaw ? Number(a.subscriberCountRaw) : 0;
        bv = b.subscriberCountRaw ? Number(b.subscriberCountRaw) : 0;
      } else if (key === "ratio") {
        av = a.ratio != null && !Number.isNaN(a.ratio) ? Number(a.ratio) : 0;
        bv = b.ratio != null && !Number.isNaN(b.ratio) ? Number(b.ratio) : 0;
      } else if (key === "exposure") {
        av = a.exposureScore != null && !Number.isNaN(a.exposureScore) ? Number(a.exposureScore) : 0;
        bv = b.exposureScore != null && !Number.isNaN(b.exposureScore) ? Number(b.exposureScore) : 0;
      }
      if (av === bv) return 0;
      return av > bv ? factor : -factor;
    });
    currentSort = { key, dir };
    if (rerender) {
      renderCurrentView();
      updateRatioChart();
      updateHeatmap();
      updateTop10Keywords();
    }
  }

  function applyFilters() {
    const lengthFilterSelect = document.getElementById("lengthFilter");
    const dateFilterSelect   = document.getElementById("dateFilter");
    const subsMinInput       = document.getElementById("subsMinInput");
    const subsMaxInput       = document.getElementById("subsMaxInput");
    const sustainOnlyCheckbox= document.getElementById("sustainOnlyCheckbox");

    clearResults();
    setError("");

    if (!allVideos.length) {
      const resultsEl = document.getElementById("results");
      if (resultsEl) resultsEl.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      filteredVideos = [];
      updateRatioChart();
      updateHeatmap();
      updateTop10Keywords();
      return;
    }

    const lengthOption = lengthFilterSelect.value;
    const dateOption   = dateFilterSelect.value;
    const selectedRatioLevels = getSelectedRatioLevels();
    const selectedExposureLevels = getSelectedExposureLevels();
    const sustainOnly = sustainOnlyCheckbox && sustainOnlyCheckbox.checked;
    const { thresholdDate } = getDateFilterRange(dateOption);

    let filtered = allVideos.slice();

    filtered = filtered.filter(v => {
      if (!v.durationSeconds || v.durationSeconds <= 0) return lengthOption === "all";
      if (lengthOption === "short") return v.durationSeconds < 60;
      if (lengthOption === "long") return v.durationSeconds >= 60;
      return true;
    });

    if (thresholdDate) {
      filtered = filtered.filter(v => v.publishedAt && v.publishedAt >= thresholdDate);
    }

    const subsMin = subsMinInput && subsMinInput.value !== "" ? Number(subsMinInput.value) : null;
    const subsMax = subsMaxInput && subsMaxInput.value !== "" ? Number(subsMaxInput.value) : null;
    if (subsMin !== null || subsMax !== null) {
      filtered = filtered.filter(v => {
        const subsNum = v.subscriberCountRaw ? Number(v.subscriberCountRaw) : 0;
        if (subsMin !== null && subsNum < subsMin) return false;
        if (subsMax !== null && subsNum > subsMax) return false;
        return true;
      });
    }

    if (selectedRatioLevels.length) {
      filtered = filtered.filter(v => v.ratioLevel != null && selectedRatioLevels.includes(v.ratioLevel));
    }
    if (selectedExposureLevels.length) {
      filtered = filtered.filter(v => v.exposureLevel != null && selectedExposureLevels.includes(v.exposureLevel));
    }
    if (sustainOnly) filtered = filtered.filter(v => v.isSustained);

    filteredVideos = filtered;

    if (currentSort.key && currentSort.dir) sortFiltered(currentSort.key, currentSort.dir, false);

    if (filtered.length) setStatus(`ì´ ${allVideos.length}ê°œ ì¤‘ í•„í„° ì ìš© ê²°ê³¼ ${filtered.length}ê°œ í‘œì‹œ`);
    else setStatus("");

    renderCurrentView();
    updateRatioChart();
    updateHeatmap();
    updateTop10Keywords();
  }

  function exportToCSV() {
    const data = filteredVideos.length ? filteredVideos : allVideos;
    if (!data.length) { alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê²€ìƒ‰ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”."); return; }

    const headers = ["Video ID","ì œëª©","ì±„ë„","êµ¬ë…ììˆ˜","ì¡°íšŒìˆ˜","ê¸°ì—¬ë„(ë‹¨ê³„)","ë…¸ì¶œí™•ë¥ (ë‹¨ê³„)","ì§€ì†ì„±(ì§€ì† ì„±ì¥ ì—¬ë¶€)","ê¸¸ì´(ì´ˆ)","ê¸¸ì´(í‘œì‹œ)","ì—…ë¡œë“œì¼","íƒœê·¸","ì„¤ëª…"];
    const escapeCSV = (value) => {
      if (value === null || value === undefined) return "";
      const str = String(value).replace(/"/g, '""');
      return (str.search(/("|,|\n)/g) >= 0) ? '"' + str + '"' : str;
    };

    const rows = data.map(v => {
      const ratioLabelStr = v.ratioLevel != null ? getRatioLabel(v.ratioLevel) : "";
      const exposureLabelStr = v.exposureLevel != null ? getExposureLabel(v.exposureLevel) : "";
      const sustainStr = v.isSustained ? "ì§€ì† ì„±ì¥" : "";
      const tagsJoined = v.tags && v.tags.length ? v.tags.join(" | ") : "";
      const dateStr = v.publishedAtRaw ? v.publishedAtRaw.slice(0,10) : "";
      return [
        v.videoId || "",
        v.title || "",
        v.channelTitle || "",
        v.subscriberCountRaw || "",
        v.viewCountRaw || "",
        ratioLabelStr,
        exposureLabelStr,
        sustainStr,
        v.durationSeconds || "",
        v.durationText || "",
        dateStr,
        tagsJoined,
        v.description || ""
      ].map(escapeCSV).join(",");
    });

    const csvContent = [headers.map(escapeCSV).join(","), ...rows].join("\n");
    const csvWithBom = "\ufeff" + csvContent;
    const blob = new Blob([csvWithBom], { type: "text/csv;charset=utf-8;" });

    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    const now = new Date();
    const timestamp =
      now.getFullYear().toString() +
      String(now.getMonth()+1).padStart(2,"0") +
      String(now.getDate()).padStart(2,"0") + "_" +
      String(now.getHours()).padStart(2,"0") +
      String(now.getMinutes()).padStart(2,"0") +
      String(now.getSeconds()).padStart(2,"0");

    link.href = url;
    link.download = "youtube_results_" + timestamp + ".csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  async function searchYouTube(query) {
    const apiKey = (getStoredApiKeyDecrypted() || "").trim();
    if (!apiKey) {
      alert("ë¨¼ì € ìƒë‹¨ [ì„¤ì •]ì—ì„œ YouTube API í‚¤ë¥¼ ì…ë ¥í•˜ê³  [ì €ì¥]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
      const settingsArea = document.getElementById("settingsArea");
      if (settingsArea) settingsArea.style.display = "block";
      return;
    }
    if (!query || !query.trim()) { alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    const lengthFilterSelect = document.getElementById("lengthFilter");
    const dateFilterSelect   = document.getElementById("dateFilter");

    const trimmedQuery = query.trim();
    const { thresholdDate, publishedAfter } = getDateFilterRange(dateFilterSelect.value);

    clearResults();
    setError("");
    setStatus("ë¡œë”© ì¤‘...", true);
    currentSort = { key: null, dir: null };
    allVideos = [];
    filteredVideos = [];
    updateRatioChart();
    updateHeatmap();

    try {
      let allSearchItems = [];
      let pageToken = null;
      const maxPages = 5;
      let page = 0;

      do {
        page++;
        setStatus(`ê²€ìƒ‰ ì¤‘... (${page}/${maxPages} í˜ì´ì§€)`, true);

        const searchData = await fetchSearchResults(apiKey, trimmedQuery, publishedAfter, pageToken);
        allSearchItems = allSearchItems.concat(searchData.items || []);
        pageToken = searchData.nextPageToken || null;
      } while (pageToken && page < maxPages);

      if (!allSearchItems.length) {
        setStatus("");
        const resultsEl = document.getElementById("results");
        if (resultsEl) resultsEl.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      const videoIds = allSearchItems.map(it => it.id && it.id.videoId).filter(Boolean);
      if (!videoIds.length) {
        setStatus("");
        const resultsEl = document.getElementById("results");
        if (resultsEl) resultsEl.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      const videoData = await fetchVideoDetails(apiKey, videoIds);
      const videoItems = videoData.items || [];
      if (!videoItems.length) {
        setStatus("");
        const resultsEl = document.getElementById("results");
        if (resultsEl) resultsEl.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      const channelIds = Array.from(new Set(videoItems.map(v => v.snippet && v.snippet.channelId).filter(Boolean)));
      const channelData = await fetchChannelDetails(apiKey, channelIds);
      const channelMap = {};
      (channelData.items || []).forEach(ch => { channelMap[ch.id] = ch; });

      const now = new Date();
      allVideos = videoItems.map(video => {
        const snippet = video.snippet || {};
        const statistics = video.statistics || {};
        const contentDetails = video.contentDetails || {};
        const channelId = snippet.channelId;
        const channel = channelMap[channelId] || {};
        const channelSnippet = channel.snippet || {};
        const channelStats = channel.statistics || {};

        const publishedAtStr = snippet.publishedAt || null;
        const publishedAt = publishedAtStr ? new Date(publishedAtStr) : null;

        const durationSeconds = parseDurationToSeconds(contentDetails.duration || null);

        const viewCountRaw = statistics.viewCount || null;
        const subscriberCountRaw = channelStats.subscriberCount || null;
        const viewCountNum = viewCountRaw ? Number(viewCountRaw) : null;
        const subscriberCountNum = subscriberCountRaw ? Number(subscriberCountRaw) : null;

        let ratio = null;
        if (subscriberCountNum && subscriberCountNum > 0 && viewCountNum !== null && viewCountNum >= 0) {
          ratio = viewCountNum / subscriberCountNum;
        }
        const ratioLevel = getRatioLevel(ratio);

        let daysSincePublished = null;
        if (publishedAt) {
          const diffMs = now - publishedAt;
          daysSincePublished = diffMs > 0 ? diffMs / (1000*60*60*24) : 0;
        }

        let viewsPerDay = null;
        if (viewCountNum !== null && daysSincePublished !== null && daysSincePublished > 0.5) {
          viewsPerDay = viewCountNum / daysSincePublished;
        }

        return {
          videoId: video.id,
          title: snippet.title || "ì œëª© ì •ë³´ ì—†ìŒ",
          channelId,
          channelTitle: channelSnippet.title || snippet.channelTitle || "ì±„ë„ ì •ë³´ ì—†ìŒ",
          description: snippet.description || "",
          thumbnailUrl:
            (snippet.thumbnails &&
             (snippet.thumbnails.medium || snippet.thumbnails.high || snippet.thumbnails.default) &&
             (snippet.thumbnails.medium || snippet.thumbnails.high || snippet.thumbnails.default).url) || "",
          tags: snippet.tags || [],
          viewCountRaw,
          subscriberCountRaw,
          viewCountFormatted: formatNumberWithCommas(viewCountRaw),
          subscriberCountFormatted: formatNumberWithCommas(subscriberCountRaw),
          durationSeconds,
          durationText: formatDuration(durationSeconds),
          publishedAt,
          publishedAtRaw: publishedAtStr,
          ratio,
          ratioLevel,
          daysSincePublished,
          viewsPerDay,
          exposureScore: null,
          exposureLevel: null,
          isSustained: false,
        };
      });

      if (thresholdDate) {
        allVideos = allVideos.filter(v => v.publishedAt && v.publishedAt >= thresholdDate);
      }

      computeExposureAndSustain(allVideos);
      saveSearchHistory(trimmedQuery);

      setStatus("");
      applyFilters();
    } catch (err) {
      console.error("YouTube API ì˜¤ë¥˜:", err);
      setStatus("");
      setError("API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
      alert("API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì½˜ì†”(F12)ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      allVideos = [];
      filteredVideos = [];
      updateRatioChart();
      updateHeatmap();
    }
  }

  // =============================
  // âœ… ì—¬ê¸°ì„œë¶€í„° 'ë‹¨ 1ë²ˆ' ì´ˆê¸°í™”
  // =============================
  document.addEventListener("DOMContentLoaded", async () => {
    // 1) ë¡œê·¸ì¸ í™•ì¸ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
    const user = await requireLoginOrRedirect();
    if (!user) return;

    // 2) ì´ì œë¶€í„° UI í‘œì‹œ
    const appRoot = document.getElementById("appRoot");
    if (appRoot) appRoot.style.display = "block";

    // 3) DOM ìºì‹±
    const apiKeyInput = document.getElementById("apiKeyInput");
    const saveApiKeyBtn = document.getElementById("saveApiKeyBtn");
    const queryInput = document.getElementById("queryInput");
    const searchBtn = document.getElementById("searchBtn");
    const lengthFilterSelect = document.getElementById("lengthFilter");
    const dateFilterSelect = document.getElementById("dateFilter");
    const ratioResetBtn = document.getElementById("ratioResetBtn");
    const exposureResetBtn = document.getElementById("exposureResetBtn");
    const subsMinInput = document.getElementById("subsMinInput");
    const subsMaxInput = document.getElementById("subsMaxInput");
    const sustainOnlyCheckbox = document.getElementById("sustainOnlyCheckbox");
    const cardViewBtn = document.getElementById("cardViewBtn");
    const tableViewBtn = document.getElementById("tableViewBtn");
    const exportBtn = document.getElementById("exportBtn");
    const settingsArea = document.getElementById("settingsArea");
    const settingsBtn = document.getElementById("settingsBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userGreetingEl = document.getElementById("userGreeting");

    // 4) ìœ ì € í‘œì‹œ
    if (userGreetingEl) userGreetingEl.textContent = (user && user.name) ? `${user.name} (Pro Member)` : "";

    // 5) ì €ì¥ëœ APIí‚¤ ë³µì› + ì„¤ì •ì˜ì—­ í‘œì‹œ ì—¬ë¶€
    const savedKey = getStoredApiKeyDecrypted();
    if (apiKeyInput && savedKey) apiKeyInput.value = savedKey;
    updateApiMetaText();
    if (settingsArea) settingsArea.style.display = savedKey ? "none" : "block";

    // 6) ë¡œê·¸ì•„ì›ƒ
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        try {
          await fetch("/.netlify/functions/logout", { method: "POST", credentials: "include" });
        } catch {}
        window.location.replace("login.html?logged_out=1");
      });
    }

    // 7) ì„¤ì • í† ê¸€
    if (settingsBtn) {
      settingsBtn.addEventListener("click", () => {
        if (!settingsArea) return;
        settingsArea.style.display = (settingsArea.style.display === "none") ? "block" : "none";
      });
    }

    // 8) API Key ì €ì¥
    if (saveApiKeyBtn) {
      saveApiKeyBtn.addEventListener("click", () => saveApiKeyToStorage(apiKeyInput.value));
    }

    // 9) ê²€ìƒ‰
    if (searchBtn) searchBtn.addEventListener("click", () => searchYouTube(queryInput.value));
    if (queryInput) {
      queryInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") searchYouTube(queryInput.value);
      });
      queryInput.focus();
    }

    // 10) í•„í„° ì´ë²¤íŠ¸
    if (lengthFilterSelect) lengthFilterSelect.addEventListener("change", applyFilters);
    if (dateFilterSelect) dateFilterSelect.addEventListener("change", applyFilters);
    if (subsMinInput) subsMinInput.addEventListener("change", applyFilters);
    if (subsMaxInput) subsMaxInput.addEventListener("change", applyFilters);

    document.querySelectorAll(".ratio-checkbox").forEach(cb => cb.addEventListener("change", applyFilters));
    document.querySelectorAll(".exposure-checkbox").forEach(cb => cb.addEventListener("change", applyFilters));
    if (sustainOnlyCheckbox) sustainOnlyCheckbox.addEventListener("change", applyFilters);

    // ê¸°ì—¬ë„ ì „ì²´ í† ê¸€
    if (ratioResetBtn) {
      ratioResetBtn.addEventListener("click", () => {
        const cbs = document.querySelectorAll(".ratio-checkbox");
        const allChecked = Array.from(cbs).every(cb => cb.checked);
        cbs.forEach(cb => cb.checked = !allChecked);
        applyFilters();
      });
    }

    // ë…¸ì¶œí™•ë¥  ì „ì²´ í† ê¸€
    if (exposureResetBtn) {
      exposureResetBtn.addEventListener("click", () => {
        const cbs = document.querySelectorAll(".exposure-checkbox");
        const allChecked = Array.from(cbs).every(cb => cb.checked);
        cbs.forEach(cb => cb.checked = !allChecked);
        applyFilters();
      });
    }

    // ë·° í† ê¸€
    if (cardViewBtn) {
      cardViewBtn.addEventListener("click", () => {
        if (currentViewMode === "card") return;
        currentViewMode = "card";
        cardViewBtn.classList.add("active");
        tableViewBtn.classList.remove("active");
        renderCurrentView();
      });
    }
    if (tableViewBtn) {
      tableViewBtn.addEventListener("click", () => {
        if (currentViewMode === "table") return;
        currentViewMode = "table";
        tableViewBtn.classList.add("active");
        cardViewBtn.classList.remove("active");
        renderCurrentView();
      });
    }

    // ì—‘ì…€ ì €ì¥
    if (exportBtn) exportBtn.addEventListener("click", exportToCSV);

    // ì‚¬ìš©ë°©ë²• íŒì—…
    const howToBtn = document.getElementById("howToBtn");
    const popupBg = document.getElementById("popupBg");
    const popupWindow = document.getElementById("popupWindow");
    const closePopupBtn = document.getElementById("closePopupBtn");
    const dontShowAgainCheckbox = document.getElementById("dontShowAgain");
    const POPUP_HIDE_KEY = "yt_api_popup_hide";

    function openPopup() {
      if (popupBg) popupBg.style.display = "block";
      if (popupWindow) popupWindow.style.display = "block";
    }
    function closePopup() {
      if (dontShowAgainCheckbox && dontShowAgainCheckbox.checked) {
        try { localStorage.setItem(POPUP_HIDE_KEY, "1"); } catch {}
      }
      if (popupBg) popupBg.style.display = "none";
      if (popupWindow) popupWindow.style.display = "none";
    }

    if (howToBtn) howToBtn.addEventListener("click", openPopup);
    if (popupBg) popupBg.addEventListener("click", closePopup);
    if (closePopupBtn) closePopupBtn.addEventListener("click", closePopup);

    try {
      const hiddenFlag = localStorage.getItem(POPUP_HIDE_KEY);
      if (!hiddenFlag) setTimeout(openPopup, 500);
    } catch {}
  });
</script>

</body>
</html>
