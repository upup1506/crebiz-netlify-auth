<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CreBiz Login</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b1220;color:#e5e7eb}
    .card{width:min(420px,92vw);background:#111827;border:1px solid #1f2937;border-radius:18px;padding:22px;box-shadow:0 20px 50px rgba(0,0,0,.35)}
    h1{font-size:18px;margin:0 0 10px}
    .desc{font-size:13px;opacity:.8;margin:0 0 18px;line-height:1.5}
    label{display:block;font-size:13px;margin:12px 0 6px;opacity:.9}
    input{width:100%;box-sizing:border-box;padding:11px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;outline:none}
    input:focus{border-color:#60a5fa}
    button{width:100%;margin-top:14px;padding:11px 12px;border-radius:999px;border:0;background:#2563eb;color:white;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .err{margin-top:10px;color:#f87171;font-size:13px;min-height:18px}
  </style>
</head>
<body>
  <div class="card">
    <h1>CreBiz YouTube Analytics Tool</h1>
    <p class="desc">아이디/비밀번호를 입력해주세요. (계정 정보는 이 페이지에 저장되지 않습니다)</p>

    <form id="form">
      <label for="id">아이디</label>
      <input id="id" autocomplete="username" />

      <label for="pw">비밀번호</label>
      <input id="pw" type="password" autocomplete="current-password" />

      <button id="btn" type="submit">로그인</button>
      <div class="err" id="err"></div>
    </form>
  </div>

  <script>
    // ✅ login.html 들어오면 혹시 남아있던 쿠키 세션을 정리(선택)
    // (원하면 주석 해제)
    // fetch("/.netlify/functions/logout", { method: "POST", credentials: "include" });

    const form = document.getElementById("form");
    const btn = document.getElementById("btn");
    const err = document.getElementById("err");

    function setError(msg) { err.textContent = msg || ""; }
    function setLoading(on) {
      btn.disabled = !!on;
      btn.textContent = on ? "로그인 중..." : "로그인";
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      setError("");

      const id = (document.getElementById("id").value || "").trim();
      const pw = (document.getElementById("pw").value || "").trim();

      if (!id || !pw) {
        setError("아이디/비밀번호를 입력해주세요.");
        return;
      }

      setLoading(true);

      try {
        const res = await fetch("/.netlify/functions/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ id, pw })
        });

        // ✅ 우리 login.js는 성공 시 {ok:true} JSON
        // 실패 시에는 텍스트일 수도 있어서 안전하게 처리
        let data = null;
        const text = await res.text();
        try { data = JSON.parse(text); } catch { data = null; }

        if (!res.ok) {
          setError(data?.message || text || "로그인 실패");
          setLoading(false);
          return;
        }

        if (!data || data.ok !== true) {
          setError("로그인 실패");
          setLoading(false);
          return;
        }

        // ✅ 성공: 서버가 HttpOnly 세션 쿠키를 심어줌
        location.replace("/tool.html");
      } catch (e2) {
        setError("네트워크 오류. 잠시 후 다시 시도해주세요.");
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
